<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฑุตุฏ ูุตุฑ 2025 - ุจูุงูุงุช ุญูุฉ ูุญููู ูุจุชูุฑุฉ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ุงูุชูุญูุฏ ุงูุฃุณุงุณู ููุฎุท ูุงูุฎูููุฉ */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0d1117; /* ุฎูููุฉ ุฏุงููุฉ ุฌุฏุงู (Dark Mode) */
            color: #ffffff;
            direction: rtl;
        }
        
        /* ุงููุชุบูุฑุงุช ูุงูุชุตูููุงุช ุงููุฎุตุตุฉ */
        :root {
            --bg-card: #161b22; /* ููู ุฏุงูู ููููุงู ุนู ุงูุฎูููุฉ */
            --border: #30363d;
            --primary-color: #3b82f6; /* blue-500 */
        }
        
        /* ุชุฃุซูุฑุงุช ุงูุจุทุงูุงุช: ุนูู ูุงุฑุชูุงุน ุนูุฏ ุงูุชุญููู */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            will-change: transform, box-shadow;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* ุฅุถุงูุฉ ุธู ุฎููู */
        }
        .card:hover {
            transform: translateY(-4px); /* ุงุฑุชูุงุน ุฃูู ูุฃูุซุฑ ุณูุงุณุฉ */
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15); /* ุธู ุจููู ุฃุฒุฑู ุฎููู */
        }
        
        /* ุฃููููุฉ ุงูุฑูุงุญ ุงููุชุญุฑูุฉ */
        .wind-icon {
            animation: wind-spin 5s linear infinite;
            transform-origin: center center;
        }
        @keyframes wind-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .governorate-btn { text-align: right; justify-content: flex-end; }

        /* ุณุชุงููุงุช ุตูุญุฉ ุงูุญููู */
        .solution-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .solution-card:hover {
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        /* ุชูุญูุฏ ูุธูุฑ ุญููู ุงูุฅุฏุฎุงู ูู ุงูุจุทุงูุงุช */
        #carbon-form input {
            background-color: #2f333b; /* ููู ุฎูููุฉ ุญูู ุงูุฅุฏุฎุงู ุฃูุชุญ ููููุงู */
            border: 1px solid #4b5563; /* ุญุฏูุฏ ูุงุถุญุฉ */
            color: white;
            padding: 0.5rem;
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #carbon-form input:focus {
            border-color: #3b82f6; /* ููู ุฃุฒุฑู ุนูุฏ ุงูุชุฑููุฒ */
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* ุณุชุงูู ุฒุฑ ุงูุญุณุงุจ ูููุงุณุจ ููุญุฉ ุงูุชุญูู */
        #carbon-form button {
            background-color: #3b82f6; /* bg-blue-500 */
            width: 100%;
            margin-top: 10px;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
        }
        #carbon-form button:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
    </style>
</head>

<body>
    <div id="app-container">
    </div>

    <script>
        // *****************************************************************
        // 1. ููุงุชูุญ ุงูู API (ุงูููุงุชูุญ ุงูุฎุงุตุฉ ุจู)
        // *****************************************************************
        const OWM_API_KEY = 'cbb0b418fa24260a8df56c9a7cd14c4e'; // OpenWeatherMap
        const WAQI_TOKEN = 'd1adfbee8313c81608cca5a505b9ed5e38f59823';  // WAQI (aqi.info)
        // ููุชุงุญ API ูุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุงูุชุฑุงุญุงุช
        const AI_SUGGESTIONS_API_KEY = 'AIzaSyAyGeZ__DlmvvzOT5CwSdZINpFvuZRIcHA'; 
        
        // *****************************************************************
        // 2. ุฅุฏุงุฑุฉ ุงูุญุงูุฉ (State Management)
        // *****************************************************************
        let currentView = 'dashboard'; // 'dashboard' ุฃู 'solutions'
        let selectedCity = 'ุงููุงูุฑุฉ';
        let weatherData = null;
        let airQualityData = null;
        let healthRiskData = null;
        let treeCoverageData = null; 
        let disasterWarningData = null;
        let loading = true;
        let chatbotResponse = null; 
        
        // *** ุฅุถุงูุฉ ุญุงูุฉ ุงููุนุจุฉ ุงููุฏูุฌุฉ ููุง ***
        let treesPlanted = 0; 

        const colors = {
            background: 'bg-gray-900', card: 'bg-gray-800', border: 'border-gray-700',
            primary: 'text-blue-400', primaryBg: 'bg-blue-400', primaryForeground: 'text-gray-900',
            foreground: 'text-white', mutedForeground: 'text-gray-400', mutedBg: 'bg-gray-700/30',
            secondaryAccent: 'text-amber-400',
        };

        // *****************************************************************
        // 3. ุจูุงูุงุช ุงููุญุงูุธุงุช (ููุณุนุฉ ูุน ุงูููุงุฑุฏ)
        // *****************************************************************
        const governorates = {
            "ุงููุงูุฑุฉ": { lat: 30.0444, lon: 31.2357, treeCoverage: 12 }, "ุงูุฌูุฒุฉ": { lat: 30.0131, lon: 31.2089, treeCoverage: 8 }, "ุงูุฅุณููุฏุฑูุฉ": { lat: 31.2001, lon: 29.9187, treeCoverage: 18 },
            "ุงูููููุจูุฉ": { lat: 30.4131, lon: 31.2096, treeCoverage: 17 }, "ุงูุดุฑููุฉ": { lat: 30.5878, lon: 31.5010, treeCoverage: 9 }, "ุงูุฏููููุฉ": { lat: 31.0559, lon: 31.3806, treeCoverage: 15 },
            "ุงููููููุฉ": { lat: 30.4514, lon: 30.9780, treeCoverage: 22 }, "ุงูุจุญูุฑุฉ": { lat: 31.0063, lon: 30.5673, treeCoverage: 11 }, "ุงูุบุฑุจูุฉ": { lat: 30.8674, lon: 31.0331, treeCoverage: 10 },
            "ููุฑ ุงูุดูุฎ": { lat: 31.3085, lon: 30.9416, treeCoverage: 25 }, "ุงูุฏููุงุท": { lat: 31.4169, lon: 31.8133, treeCoverage: 17 }, "ุฃุณููุท": { lat: 27.1818, lon: 31.1894, treeCoverage: 6 },
            "ุฃุณูุงู": { lat: 24.0889, lon: 32.8998, treeCoverage: 4 }, "ุงูุฃูุตุฑ": { lat: 25.6870, lon: 32.6396, treeCoverage: 7 }, "ููุง": { lat: 26.1601, lon: 32.7214, treeCoverage: 5 },
            "ุณููุงุฌ": { lat: 26.5566, lon: 31.6934, treeCoverage: 8 }, "ุงููููุง": { lat: 28.1065, lon: 30.7516, treeCoverage: 9 }, "ุจูู ุณููู": { lat: 29.0772, lon: 31.0975, treeCoverage: 13 },
            "ุงููููู": { lat: 29.3090, lon: 30.8427, treeCoverage: 14 }, "ุจูุฑุณุนูุฏ": { lat: 31.2589, lon: 32.2831, treeCoverage: 16 }, "ุงูุฅุณูุงุนูููุฉ": { lat: 30.6053, lon: 32.2723, treeCoverage: 11 },
            "ุงูุณููุณ": { lat: 29.9737, lon: 32.5363, treeCoverage: 7 }, "ุดูุงู ุณููุงุก": { lat: 30.5654, lon: 33.7909, treeCoverage: 2 }, "ุฌููุจ ุณููุงุก": { lat: 27.9158, lon: 34.3402, treeCoverage: 1 },
            "ุงููุงุฏู ุงูุฌุฏูุฏ": { lat: 25.4667, lon: 30.5833, treeCoverage: 3 }, "ูุทุฑูุญ": { lat: 31.3551, lon: 27.2372, treeCoverage: 5 }, "ุงูุจุญุฑ ุงูุฃุญูุฑ": { lat: 27.2586, lon: 33.8124, treeCoverage: 2 }
        };

        const governorateResources = {
            "ุงููุงูุฑุฉ": { type: 'urban_nile', resources: ['ูุซุงูุฉ ุณูุงููุฉ ุนุงููุฉ', 'ููุงุทู ุตูุงุนูุฉ', 'ุฎุฏูุงุช ุญููููุฉ'], industries: ['ุตูุงุนุฉ ุงูุบุฒู ูุงููุณูุฌ', 'ุตูุงุนุฉ ุงูุณูุงุฑุงุช', 'ุชูุฑูุฑ ุงูุจุชุฑูู'], pollution: 'ุนูุงุฏู ูุฑูุจุงุชุ ุงูุจุนุงุซุงุช ุตูุงุนูุฉุ ููุงูุฉ' },
            "ุงูุฌูุฒุฉ": { type: 'urban_nile_desert', resources: ['ููุงูุน ุฃุซุฑูุฉ (ุณูุงุญุฉ)', 'ููู', 'ุตูุงุนุฉ ุฎูููุฉ'], industries: ['ุงูุฎุดุจ ูุงูุฃุซุงุซ', 'ุงูุฃุฏููุฉ', 'ุตูุงุนุฉ ุงูุจูุงุก'], pollution: 'ุชููุซ ุงูููุงูุ ุนูุงุฏู ูุฑูุจุงุชุ ุบุจุงุฑ' },
            "ุงูุฅุณููุฏุฑูุฉ": { type: 'coastal_med', resources: ['ูููุงุก (ุชุฌุงุฑุฉ)', 'ุงูุจุญุฑ ุงููุชูุณุท', 'ุตูุงุนุฉ ุงููุณูุฌ'], industries: ['ุงูุจุชุฑููููุงููุงุช', 'ุงููุณูุฌ ูุงูููุงุจุณ', 'ุชุฌุงุฑุฉ ุจุญุฑูุฉ'], pollution: 'ุชููุซ ููุงู ุงูุจุญุฑุ ุงูุจุนุงุซุงุช ุงููุตุงูุนุ ุถูุถุงุก ุงููููุงุก' },
            "ุงูุจุญุฑ ุงูุฃุญูุฑ": { type: 'coastal_red_sea_desert', resources: ['ุงูุจุญุฑ ุงูุฃุญูุฑ (ุณูุงุญุฉ)', 'ุดุนุงุจ ูุฑุฌุงููุฉ', 'ุชุนุฏูู'], industries: ['ุงูุณูุงุญุฉ ุงูุจูุฆูุฉ', 'ุงุณุชุฎุฑุงุฌ ุงููุนุงุฏู', 'ุทุงูุฉ ุงูุฑูุงุญ'], pollution: 'ุชููุซ ุงูุดูุงุทุฆุ ูุฎููุงุช ุงูุชุนุฏููุ ุงุณุชูุฒุงู ุงูููุงู' },
            "ุงููููููุฉ": { type: 'nile_delta', resources: ['ุฏูุชุง ุงูููู', 'ุฃุฑุงุถู ุฎุตุจุฉ', 'ุฒุฑุงุนุฉ (ูุญุงุตูู ุบุฐุงุฆูุฉ)'], industries: ['ุตูุงุนุงุช ุบุฐุงุฆูุฉ', 'ููุชุฌุงุช ุฌูุฏูุฉ', 'ุฃุซุงุซ'], pollution: 'ูุฎููุงุช ุฒุฑุงุนูุฉุ ูุจูุฏุงุช ููููุงุฆูุฉุ ุชููุซ ููุงู ุงูุฑู' },
            "ููุฑ ุงูุดูุฎ": { type: 'nile_delta_coastal', resources: ['ุฒุฑุงุนุฉ (ุฃุฑุฒ)', 'ุฏูุชุง ุงูููู', 'ุซุฑูุฉ ุณูููุฉ'], industries: ['ุตูุฏ ุงูุฃุณูุงู', 'ูุฒุงุฑุน ุงูุฃุฑุฒ', 'ุตูุงุนุงุช ุบุฐุงุฆูุฉ'], pollution: 'ุญุฑู ูุด ุงูุฃุฑุฒุ ุงุณุชูุฒุงู ููุงู ุงูุฑูุ ุชููุซ ุงูุจุญูุฑุงุช' },
            "ุฃุณูุงู": { type: 'upper_egypt_nile', resources: ['ุณุทูุน ุดูุณู ุนุงูู', 'ููู', 'ูุญุงุฌุฑ ุฌุฑุงููุช (ุจูุงุก)'], industries: ['ุชูููุฏ ุงูููุฑุจุงุก (ุงูุณุฏ)', 'ุชุนุฏูู', 'ุณูุงุญุฉ ุฃุซุฑูุฉ'], pollution: 'ุบุจุงุฑ ุงููุญุงุฌุฑุ ูุฎููุงุช ุงูุจูุงุกุ ุงูุจุนุงุซุงุช ูุญุทุฉ ููุฑุจุงุก' },
            "ุงูุฃูุตุฑ": { type: 'upper_egypt_nile', resources: ['ููุงูุน ุฃุซุฑูุฉ (ุณูุงุญุฉ)', 'ููู', 'ุฒุฑุงุนุฉ'], industries: ['ุงูุณูุงุญุฉ ุงูุซูุงููุฉ', 'ุงูุฒุฑุงุนุฉ ุงูุชูููุฏูุฉ', 'ุตูุงุนุงุช ูุฏููุฉ'], pollution: 'ูุฎููุงุช ุณูุงุญูุฉุ ุชููุซ ุงูููุงุก ูู ุงูุญุฑู ุงูููุดููุ ุถุบุท ุนูู ููุงุฑุฏ ุงูููุงู' },
            "ุฌููุจ ุณููุงุก": { type: 'coastal_red_sea_desert', resources: ['ุงูุจุญุฑ ุงูุฃุญูุฑ (ุณูุงุญุฉ)', 'ุฌุจุงู', 'ุทุฑู ุฏูููุฉ'], industries: ['ุงูุณูุงุญุฉ ุงูุดุงุทุฆูุฉ', 'ุตูุงุนุฉ ุงูุฎุฏูุงุช ุงูููุฌุณุชูุฉ', 'ุทุงูุฉ ุดูุณูุฉ'], pollution: 'ูุฎููุงุช ุงูููุงุฏูุ ุชููุซ ุงูุดูุงุทุฆุ ุถุบุท ุนูู ุงูุจููุฉ ุงูุชุญุชูุฉ' },
            "ุงููุงุฏู ุงูุฌุฏูุฏ": { type: 'desert', resources: ['ูุงุญุงุช', 'ุตุญุฑุงุก ุดุงุณุนุฉ', 'ุฒุฑุงุนุฉ ุงููุฎูู (ุชููุฑ)'], industries: ['ุฅูุชุงุฌ ุงูุชููุฑ', 'ุงูุณูุงุญุฉ ุงูุตุญุฑุงููุฉ', 'ุชุฎุฒูู ุงูุทุงูุฉ ุงูุดูุณูุฉ'], pollution: 'ุงุณุชูุฒุงู ุงูููุงู ุงูุฌูููุฉุ ุบุจุงุฑุ ูุฎููุงุช ุฒุฑุงุนูุฉ' },
            "ุดูุงู ุณููุงุก": { type: 'desert_coastal', resources: ['ุตุญุฑุงุก', 'ุงูุจุญุฑ ุงููุชูุณุท', 'ููุงุฌู ุงูููุญ'], industries: ['ุงุณุชุฎุฑุงุฌ ุงูููุญ', 'ุฒุฑุงุนุงุช ูุญุฏูุฏุฉ', 'ุตูุงุนุงุช ุบุฐุงุฆูุฉ ุจุณูุทุฉ'], pollution: 'ูุฎููุงุช ุงูููุงุฌูุ ุถุบุท ุนูู ุงูุดุฑูุท ุงูุณุงุญููุ ุชููุญ ุงูุชุฑุจุฉ' },
            "ูุทุฑูุญ": { type: 'desert_coastal', resources: ['ุงูุจุญุฑ ุงููุชูุณุท', 'ุทุงูุฉ ุฑูุงุญ', 'ุฒุฑุงุนุฉ ุงูุฒูุชูู'], industries: ['ุงูุณูุงุญุฉ ุงูุณุงุญููุฉ', 'ูุฒุงุฑุน ุงูุฒูุชูู', 'ุทุงูุฉ ุงูุฑูุงุญ'], pollution: 'ุชุฏููุฑ ุงูุฃุฑุงุถูุ ุถุบุท ุนูู ุงูููุงู ุงูุณุทุญูุฉุ ูุฎููุงุช ุณูุงุญูุฉ' },
            "ุงูุฏููููุฉ": { type: 'nile_delta', resources: ['ุฏูุชุง ุงูููู', 'ุฃุฑุงุถู ุฎุตุจุฉ', 'ุตูุงุนุฉ ุงูุฃุณูุฏุฉ'], industries: ['ุงูููุณูุฌุงุช', 'ุงูุฃุณูุฏุฉ ุงููููุงููุฉ', 'ุงูุฒุฑุงุนุฉ ุงูููุซูุฉ'], pollution: 'ุงูุจุนุงุซุงุช ุงููุตุงูุน ุงููููุงููุฉุ ุชููุซ ุงูููุงู ุจุงูุตุฑู ุงูุตูุงุนูุ ูุฎููุงุช ุฒุฑุงุนูุฉ' },
        };

        // *****************************************************************
        // 4. ููุชุจุฉ ุงูุฃููููุงุช (IconMap)
        // *****************************************************************
        const IconMap = {
            Tree: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10a6 6 0 0 0-12 0c0 5 6 9 6 9s6-4 6-9zM12 19v3"/></svg>`,
            Location: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
            Wind: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.7 15.3A2.5 2.5 0 1 0 10 12h8m-8-3h8m-8-3h8"/><path d="M16 4h4v4"/><path d="M4 20h4v-4"/></svg>`,
            Droplet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66c4.66 4.66 4.66 12.25 0 16.91-4.66 4.66-12.25 4.66-16.91 0-4.66-4.66-4.66-12.25 0-16.91L12 2.69z"/></svg>`,
            Sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>`,
            Satellite: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6zm0 18c-3.31 0-6-2.69-6-6h2c0 2.21 1.79 4 4 4s4-1.79 4-4h2c0 3.31-2.69 6-6 6z"/><path d="M16 8h4"/><path d="M4 8h4"/></svg>`,
            LocationLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
            AirLarge: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66c4.66 4.66 4.66 12.25 0 16.91-4.66 4.66-12.25 4.66-16.91 0-4.66-4.66-4.66-12.25 0-16.91L12 2.69z"/><path d="M12 2a10 10 0 0 0-4 1.09"/><path d="M12 2a10 10 0 0 1 4 1.09"/><path d="M12 22a10 10 0 0 0 4-1.09"/><path d="M12 22a10 10 0 0 1-4-1.09"/><path d="M22 12h-2"/><path d="M4 12h2"/></svg>`,
            Alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>`,
            Earthquake: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 16.5l2-3 2 3 2-3 2 3 2-3 2 3"/><path d="M3 10h18"/><path d="M3 14h18"/></svg>`,
            RainDrops: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10l-4 4m8-4l-4 4"/><circle cx="12" cy="18" r="4"/></svg>`,
            Thermometer: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>`,
            WindHigh: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.7 15.3A2.5 2.5 0 1 0 10 12h8m-8-3h8m-8-3h8"/><path d="M16 4h4v4"/><path d="M4 20h4v-4"/></svg>`,
            Economy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/><path d="M18 10h-5"/><path d="M16 14h-5"/></svg>`,
            Factory: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19h-1.5a1.5 1.5 0 0 1 0-3H22v3zM22 16h-3.5a1.5 1.5 0 0 1 0-3H22v3zM22 13h-4.5a1.5 1.5 0 0 1 0-3H22v3zM2 22v-2a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v2H2zM4 19V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v13H4zM9 19V9m6 10V9m-3 0v10"/></svg>`
        };

        // *****************************************************************
        // 5. ุงูุฏูุงู ุงููุณุงุนุฏุฉ (Utility Functions)
        // *****************************************************************
        const formatTime = (unixTimestamp) => {
            if (!unixTimestamp) return 'N/A';
            const date = new Date(unixTimestamp * 1000);
            return new Intl.DateTimeFormat('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: false }).format(date);
        };
        const getAqiStatus = (aqi) => {
            if (aqi === null || aqi === undefined) return "ุบูุฑ ูุชููุฑ";
            if (aqi <= 50) return "ุฌูุฏ"; if (aqi <= 100) return "ูุนุชุฏู"; if (aqi <= 150) return "ุบูุฑ ุตุญู ูููุฌููุนุงุช ุงูุญุณุงุณุฉ";
            if (aqi <= 200) return "ุบูุฑ ุตุญู"; return "ุฎุทุฑ ุฌุฏุงู";
        };
        const getAqiColor = (aqi) => {
            if (aqi === null || aqi === undefined) return "text-gray-500";
            if (aqi <= 50) return "text-green-400"; if (aqi <= 100) return "text-yellow-400"; if (aqi <= 150) return "text-orange-400";
            if (aqi <= 200) return "text-red-500"; return "text-purple-600";
        };
        const getTreeStatus = (percentage) => {
            if (percentage >= 20) return { status: "ููุชุงุฒ", recommendation: "ุงููุถุน ููุชุงุฒุ ุงุณุชูุฑ ูู ุงูุญูุงุธ ุนูู ุงููุณุงุญุงุช ุงูุฎุถุฑุงุก.", color: "text-green-400", barColor: "bg-green-500" };
            if (percentage >= 10) return { status: "ุฌูุฏุ ุชุญุชุงุฌ ูุฒูุงุฏุฉ", recommendation: "ูุถุน ุฌูุฏุ ูููุตุญ ุจุฒูุงุฏุฉ ุฒุฑุงุนุฉ ุงูุฃุดุฌุงุฑ ูุชุญุณูู ุฌูุฏุฉ ุงูููุงุก.", color: "text-yellow-400", barColor: "bg-yellow-500" };
            return { status: "ุถุนููุ ูุทููุจ ุฒุฑุงุนุฉ ููุฑูุฉ", recommendation: "ูุณุจุฉ ููุฎูุถุฉุ ููุตู ุจุจุฏุก ุญููุงุช ุฒุฑุงุนุฉ ููุฑูุฉ ูุฒูุงุฏุฉ ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ.", color: "text-red-400", barColor: "bg-red-500" };
        };
        const calculateHealthRisk = (aqi, temp, humidity) => {
            if (aqi === null || temp === null) return 0;
            let aqiWeight = Math.min(aqi / 200, 1) * 50;
            let tempFactor = 0;
            if (temp >= 35) tempFactor = 40; else if (temp >= 30) tempFactor = 25; else if (temp >= 25) tempFactor = 10;
            let humidityFactor = Math.max(0, humidity - 60) * 0.5;
            let totalRisk = aqiWeight + tempFactor + humidityFactor;
            return Math.min(100, Math.round(totalRisk)); 
        };
        const getHealthRiskStatus = (percentage, aqi, temp) => {
            let status, recommendation, color, barColor, healthDetails;
            if (percentage > 80) { status = "ุฎุทุฑ ุฌุณูู"; recommendation = "ุฅุฌุฑุงุกุงุช ุทูุงุฑุฆ ููุฑูุฉุ ูุชุฌููุฒ ุงููุณุชุดููุงุช ูุฃูุตู ุทุงูุฉ ุงุณุชูุนุงุจูุฉ."; color = "text-red-500"; barColor = "bg-red-500";
            } else if (percentage > 60) { status = "ุฎุทุฑ ูุฑุชูุน"; recommendation = "ุชูุนูู ุฎุทุท ุงูุฅูุฐุงุฑ ุงููุจูุฑ ูุฒูุงุฏุฉ ูุฑู ุงูุงุณุชุฌุงุจุฉ ูู ุงูููุงุทู ุงูุญุฑุฌุฉ."; color = "text-orange-500"; barColor = "bg-orange-500";
            } else if (percentage >= 50) { status = "ูุชูุณุท ุฅูู ูุฑุชูุน"; recommendation = "ุชุฌุงูุฒ ุญุฏ 50% ูุชุทูุจ ุฑูุน ุฏุฑุฌุฉ ุงูุงุณุชุนุฏุงุฏ ูู ุงููุฑุงูุฒ ุงูุทุจูุฉ."; color = "text-yellow-500"; barColor = "bg-yellow-500";
            } else if (percentage > 20) { status = "ููุฎูุถ"; recommendation = "ุงููุถุน ูุณุชูุฑุ ูุน ูุชุงุจุนุฉ ูุณุชููุงุช ุงูุชููุซ ูุงูุญุฑุงุฑุฉ ุจุดูู ุฏูุฑู."; color = "text-green-500"; barColor = "bg-green-500";
            } else { status = "ุขูู ุฌุฏุงู"; recommendation = "ุงููุถุน ููุชุงุฒ. ูููู ุงูุชุฑููุฒ ุนูู ุงูุฎุฏูุงุช ุงูุตุญูุฉ ุงูููุงุฆูุฉ ูุงูุฑูุชูููุฉ."; color = "text-lime-500"; barColor = "bg-lime-500"; }
            healthDetails = {
                respiratory: { level: "ููุฎูุถ", advice: "ูุง ุชูุฌุฏ ูููุฏ ุนูู ุงูุฃูุดุทุฉ ุงูุฎุงุฑุฌูุฉ.", color: "text-green-400" },
                allergy: { level: "ููุฎูุถุฉ", advice: "ูููู ููู ูุนุงููู ูู ุญุณุงุณูุฉ ุดุฏูุฏุฉ ุงุฑุชุฏุงุก ููุงุน N95 ุนูุฏ ุงููุฒูู.", color: "text-green-400" },
                heatStress: { level: "ููุฎูุถ", advice: "ุงูุญุฑุงุฑุฉ ุทุจูุนูุฉ. ูููุตุญ ุจุดุฑุจ ูููุงุช ูุงููุฉ ูู ุงููุงุก.", color: "text-lime-400" }
            };
            if (aqi > 100) { healthDetails.respiratory = { level: "ูุชูุณุท", advice: "ููุจุบู ุนูู ุงูุฃุทูุงู ููุจุงุฑ ุงูุณู ููุฑุถู ุงูุฑุจู ุชูููู ุงูุฅุฌูุงุฏ ูู ุงูููุงุก ุงูุทูู.", color: "text-yellow-400" }; healthDetails.allergy = { level: "ูุชูุณุทุฉ ุฅูู ูุฑุชูุนุฉ", advice: "ูุณุชููุงุช ูุณุจุจุงุช ุงูุญุณุงุณูุฉ ูุฑุชูุนุฉ. ููุถู ุชูุงูู ุงูุฃุฏููุฉ ุงูููุงุฆูุฉ ูุงูุญุฏ ูู ุงูุชุนุฑุถ ุงูุฎุงุฑุฌู.", color: "text-yellow-400" }; }
            if (aqi > 150) { healthDetails.respiratory = { level: "ูุฑุชูุน", advice: "ูุฌุจ ุนูู ุงูุฌููุน ุชุฌูุจ ุงูุฃูุดุทุฉ ุงูุฎุงุฑุฌูุฉ ุงูุทูููุฉ ูุงููุฌูุฏุฉ. ุนูู ูุฑุถู ุงูุฌูุงุฒ ุงูุชููุณู ุงูุจูุงุก ูู ุงูุฏุงุฎู.", color: "text-red-400" }; healthDetails.allergy = { level: "ูุฑุชูุนุฉ ุฌุฏุงู", advice: "ุถุฑูุฑุฉ ุงูุจูุงุก ูู ุงูุฏุงุฎู ูุฅุบูุงู ุงูููุงูุฐ. ุงุณุชุดุฑ ุทุจูุจู ูุฌุฑุนุงุช ุงูุฃุฏููุฉ ุงููุถุงุฏุฉ ููุญุณุงุณูุฉ.", color: "text-red-400" }; }
            if (temp >= 35) { healthDetails.heatStress = { level: "ูุฑุชูุน", advice: "ุชุญุฐูุฑ: ุฎุทุฑ ุงูุฅุตุงุจุฉ ุจุถุฑุจุฉ ุงูุดูุณ. ุชุฌูุจ ุงูุฃูุดุทุฉ ูู ุงูุธููุฑุฉุ ุงุฑุชุฏุงุก ูุจุนุฉ ูุงุชุญุฉ ุงูููู ูุงูุชุฑุทูุจ ุงููุณุชูุฑ.", color: "text-red-400" };
            } else if (temp >= 30) { healthDetails.heatStress = { level: "ูุชูุณุท", advice: "ูููุตู ุจุฃุฎุฐ ูุชุฑุงุช ุฑุงุญุฉ ูุชูุฑุฑุฉ ูุดุฑุจ ุงูุณูุงุฆู ุจูุซุฑุฉ ูููุน ุงูุฅุฌูุงุฏ ุงูุญุฑุงุฑู.", color: "text-orange-400" }; }
            return { status, recommendation, color, barColor, healthDetails };
        };
        const getDisasterWarning = (weatherData) => {
            const warnings = []; if (!weatherData) return warnings;
            const temp = weatherData?.main?.temp ?? 0, windSpeed = weatherData?.wind?.speed ?? 0, weatherDescription = weatherData?.weather?.[0]?.description ?? '', weatherMain = weatherData?.weather?.[0]?.main ?? '';
            if (temp >= 40) warnings.push({ type: "ุฎุทุฑ ุงูุญุฑุงุฑุฉ ุงููุตูู", iconColor: "text-red-500", message: `ุชุญุฐูุฑ ูู ููุฌุฉ ุญุฑ ุดุฏูุฏุฉ: ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ${Math.round(temp)}ยฐC. ุชุฌูุจ ุงูุชุนุฑุถ ุงููุจุงุดุฑ ููุดูุณ.`, priority: 4 });
            else if (temp >= 35) warnings.push({ type: "ุชุญุฐูุฑ ูู ุฅุฌูุงุฏ ุญุฑุงุฑู", iconColor: "text-orange-400", message: `ุงูุญุฑุงุฑุฉ ูุฑุชูุนุฉ: ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ${Math.round(temp)}ยฐC. ุญุงูุธ ุนูู ุงูุชุฑุทูุจ.`, priority: 3 });
            if (windSpeed >= 15) warnings.push({ type: "ุฎุทุฑ ุงูุนูุงุตู ุงูุฑูููุฉ/ุงูุชุฑุงุจูุฉ", iconColor: "text-red-500", message: `ุณุฑุนุฉ ุฑูุงุญ ุนุงููุฉ ุชุตู ุฅูู ${windSpeed.toFixed(1)} ู/ุซ. ุฎุทุฑ ุงูุนูุงุตู ุงูุชุฑุงุจูุฉ.`, priority: 5 });
            else if (windSpeed >= 10) warnings.push({ type: "ุชุญุฐูุฑ ูู ุฑูุงุญ ูููุฉ", iconColor: "text-yellow-400", message: `ุฑูุงุญ ูููุฉ ุชุตู ุฅูู ${windSpeed.toFixed(1)} ู/ุซ.`, priority: 3 });
            if (weatherMain.includes("Rain") || weatherMain.includes("Drizzle")) { let priority = 2, iconColor = "text-sky-400"; if (weatherDescription.includes("heavy") || weatherDescription.includes("ุบุฒูุฑ")) { priority = 4; iconColor = "text-blue-500"; } warnings.push({ type: "ุชุญุฐูุฑ ูู ุฃูุทุงุฑ", iconColor: iconColor, message: `ุชููุนุงุช ุจู ${weatherDescription}. ุชูุฎู ุงูุญุฐุฑ ุนูู ุงูุทุฑู.`, priority: priority }); }
            if (new Date().getMinutes() % 5 === 0) warnings.push({ type: "ุชูุจูู ุฒูุฒุงูู ุฅููููู (ูุญุงูุงุฉ)", iconColor: "text-purple-500", message: `ุฑุตุฏ ูุฒุฉ ุฃุฑุถูุฉ ุจููุฉ 5.2 ุฑูุฎุชุฑ ูู ุงูููุทูุฉ ุงููุฌุงูุฑุฉ.`, priority: 6 });
            return warnings.sort((a, b) => b.priority - a.priority);
        };
        const LoadingSpinner = (message = "ุฌุงุฑู ุงูุชุญููู...") => `
            <div class="flex flex-col justify-center items-center h-full min-h-[8rem] space-y-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-r-2 border-t-2 border-blue-400"></div>
                <p class="text-sm text-gray-400">${message}</p>
            </div>
        `;
        const CardTemplate = (title, iconSvg, colorClass, contentHtml, span = "col-span-1") => `
            <div class="card rounded-2xl p-6 shadow-xl ${span}">
                <div class="flex items-center gap-3 mb-4 border-b border-gray-700/50 pb-3">
                    <div class="w-6 h-6 ${colorClass} ${title === 'ุณุฑุนุฉ ุงูุฑูุงุญ' ? 'wind-icon' : ''}">${iconSvg}</div>
                    <span class="text-xl font-semibold text-white">${title}</span>
                </div>
                ${loading && title !== "๐ฎ ูุนุจุฉ ุงูุชุดุฌูุฑ" && title !== "๐ฑ ุงูุจุตูุฉ ุงููุฑุจูููุฉ (ุดุฎุตูุฉ)" ? LoadingSpinner(`ุฌูุจ ุจูุงูุงุช ${title}...`) : contentHtml}
            </div>
        `;

        // *****************************************************************
        // 5.5. ุฏุงูุฉ ุชูููุฏ ุฑุฏ ุงูุดุงุช ุจูุช ุงูุฐูู (Chatbot Logic - ุงูุขู ุชุณุชุฏุนู API)
        // *****************************************************************
        const fetchChatbotResponse = async () => { 
            // 1. ุฌูุน ุงูุจูุงูุงุช ุงููุทููุจุฉ ููู Prompt
            if (!treeCoverageData || !weatherData || !airQualityData) {
                // ูุญุงูุงุฉ ุณุฑูุนุฉ ูุฑุฏ ุฎุทุฃ
                await new Promise(resolve => setTimeout(resolve, 500));
                return [
                    "ุชุนุฐุฑ ุชูููุฏ ุงูุฑุฏ ุงูุฐูู ุจุณุจุจ ุฎุทุฃ ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ.",
                    "* **ุฎุทุฃ:** ุจูุงูุงุช ุงูุทูุณุ ุฌูุฏุฉ ุงูููุงุกุ ุฃู ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ ุบูุฑ ูุชููุฑุฉ ุจุดูู ูุงูู."
                ];
            }
            const resources = governorateResources[selectedCity] || { type: 'generic', resources: ['ููู', 'ุฒุฑุงุนุฉ'] };
            const treeData = treeCoverageData;
            const aqi = airQualityData?.data?.aqi ?? 0;
            const temp = weatherData?.main?.temp ?? 0;
            const windSpeed = weatherData?.wind?.speed ?? 0;
            
            // 2. ุจูุงุก ุงูู Prompt
            const prompt = `
                ุฃูุช ุฎุจูุฑ ูู ุงูุงุณุชุฏุงูุฉ ุงูุจูุฆูุฉ ููุฏู ุงูุดุฑู ุงูุฃูุณุท. ูููุชู ูู ุชุญููู ุงูุจูุงูุงุช ุงูุชุงููุฉ ููุญุงูุธุฉ "${selectedCity}" ูู ูุตุฑ (ูุงูุชู ุชุชููุฒ ุจุงูููุงุฑุฏ: ${resources.resources.join(', ')}). 
                ูุฏู ุชุญูููุงู ููุตูุงู ูุชูุตูุงุช ุฐููุฉ ููุจุชูุฑุฉ ููุญุฏุฏุฉ ุนูู ุดูู ูุงุฆูุฉ ููุทูุฉ.
                
                ุจูุงูุงุช ุงููุฑุตุฏ ุงูุญุงููุฉ:
                - ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ: ${treeData.percentage}% (ุงููุถุน: ${treeData.status}).
                - ูุคุดุฑ ุฌูุฏุฉ ุงูููุงุก (AQI): ${aqi} (ุงููุถุน: ${getAqiStatus(aqi)}).
                - ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ: ${temp}ยฐC.
                - ุณุฑุนุฉ ุงูุฑูุงุญ: ${windSpeed.toFixed(1)} ู/ุซ.
                
                ูุฑุฌู ุงูุชุฑููุฒ ุนูู:
                1. **ุชุญููู ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ:** ูู ูู ูุงููุฉุ ููุง ูู ุฃููุงุน ุงูุฃุดุฌุงุฑ ุงูููุชุฑุญุฉ ุจูุงุกู ุนูู ุงูููุงุฑุฏุ
                2. **ุชุญููู ุฌูุฏุฉ ุงูููุงุก ูุงูุญุฑุงุฑุฉ:** ูุง ูู ุงููุฎุงุทุฑ ุงูุตุญูุฉ ูุงูุจูุฆูุฉุ ููุง ูู ุงูุญููู ุงูุนุงุฌูุฉ ูุฎูุถ ุงูุชููุซ (ูุซู LEZุ ุฃู ุฅุฏุงุฑุฉ ุงููุฑูุฑ ุงูุฐููุฉ)ุ
                3. **ุญููู ุงูุทุงูุฉ ุงููุณุชุฏุงูุฉ:** ูุง ูู ุงููุดุงุฑูุน ุงูููููุฉ ููุฑุงู ููุงุณุชูุงุฏุฉ ูู ููุงุฑุฏ ุงููุญุงูุธุฉ (ูุซู ุงูุณุทูุน ุงูุดูุณู ุงูุนุงููุ ุฃู ุทุงูุฉ ุงูุฑูุงุญ ุงูุณุงุญููุฉ)ุ
                
                ุงุจุฏุฃ ุฑุฏู ุจุชุญูุฉ ูุงูุชุฑุงุญุงุชู ูุฎุจูุฑ. ุงุณุชุฎุฏู ุงูุฑูุฒ '*' ูุจู ูู ููุทุฉ ุชุญููู ุฃู ุชูุตูุฉ.
            `;
            
            // 3. ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจุงูู API (ูุญุงูุงุฉ ุงูุงุชุตุงู)
            const AI_API_ENDPOINT = 'https://mock-ai-service-for-dashboard.com/generate';
            
            try {
                // ูุญุงูุงุฉ ุชุฃุฎูุฑ ุงูู API ูุฑุฏู (ููุชุฌุฑุจุฉ)
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                
                // ููุง ูุชู ุจูุงุก ุฑุฏ ูุญุงูู ููู ูุนูู ุงูุนุฑุถ ุจุดูู ุตุญูุญ
                const mockResponseText = `
                    ุฃููุงู ุจู ูู ุฎุฏูุฉ ุงูุฎุจูุฑ ุงูุจูุฆู ููุฐูุงุก ุงูุงุตุทูุงุนู! ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ ูู ูุฑุตุฏ ูุตุฑ 2025 ูู **${selectedCity}**ุ ุฅููู ุงูุชุญููู ูุงูุชูุตูุงุช:

                    * **ุชุญููู ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ:** ุงููุณุจุฉ ุงูุญุงููุฉ ูู ${treeData.percentage}%. ุงููุถุน **${treeData.status}**. ุงูุชูุตูุฉ: ูุฌุจ ุนูู ุงูููุฑ ุชุทุจูู ุฎุทุฉ "ููููู ุดุฌุฑุฉ ูููุฏููุฉ" ูุงูุชุฑููุฒ ุนูู ุงูุฒุฑุงุนุงุช ุงูุฑุฃุณูุฉ ูู ุงูููุงุทู ุฐุงุช ุงููุซุงูุฉ ุงูุนุงููุฉ.
                    * **ุชุญููู ุฌูุฏุฉ ุงูููุงุก ูุงูุญุฑุงุฑุฉ:** ูุคุดุฑ AQI ูุจูุบ ${aqi}. ุงููุถุน ุงูุนุงู ูู **${getAqiStatus(aqi)}**. ุงูุชูุตูุฉ: ูููุชุฑุญ ุงูุจุฏุก ูู ุฅูุดุงุก ููุงุทู ููุฎูุถุฉ ุงูุงูุจุนุงุซุงุช (LEZ) ูุชูููู ุนูุงุฏู ุงููุฑูุจุงุช ุงููุฏููุฉ.
                    * **ุญููู ุงูุทุงูุฉ ุงููุณุชุฏุงูุฉ:** ุจูุง ุฃู ุงููุญุงูุธุฉ ูุฏููุง ููุงุฑุฏ ูุซู ${resources.resources.join(', ')}ุ ูููุตู ุจุชูุณูุน ุชุฑููุจ **ุงูุฃููุงุญ ุงูุดูุณูุฉ** ุนูู ุฃุณุทุญ ุงููุจุงูู ูุฎูุถ ูุงุชูุฑุฉ ุงูุทุงูุฉ ูุชูููู ุงูุถุบุท ุนูู ุงูุดุจูุฉ.
                    * **ุงูุชูุตูุฉ ุงูููุงุฆูุฉ:** ุงุณุชุซูุฑ ูู ุญููู ุงูุชุจุฑูุฏ ุงูุทุจูุนู ูุซู ุฒูุงุฏุฉ ุงูุธูุงู ูุงููุณุทุญุงุช ุงููุงุฆูุฉ ูุชูููู ุชุฃุซูุฑ ุงุฑุชูุงุน ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงูุชู ูุตูุช ุฅูู ${temp}ยฐC.
                `;
                
                // ุชุญููู ุงููุต ุงููุญุงูุงุฉ ุฅูู ูุตูููุฉ ูู ุงูุณุทูุฑ
                return mockResponseText.split('\n').filter(line => line.trim() !== '');

            } catch (error) {
                console.error("Failed to fetch AI chatbot response:", error);
                // ุฑุฏ ุงุญุชูุงุทู ูู ุญุงูุฉ ุงููุดู
                return [
                    "ุชุนุฐุฑ ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู.",
                    "* **ุงูุชุญููู ุงูุงุญุชูุงุทู:** ูุคุดุฑุงุช ุจูุงูุงุช ุงููุฑุตุฏ ูุชููุฑุฉุ ูููู ูู ูุชููู ูู ุชูููุฏ ุงูุงูุชุฑุงุญุงุช ุงูุฐููุฉ. ูุฑุฌู ูุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช ุงูู API ูุงูููุชุงุญ ุงูุฌุฏูุฏ."
                ];
            }
        };

        // *****************************************************************
        // 5.6. ุฏุงูุฉ ุชูููุฏ ุงูุชุญููู ุงูุงูุชุตุงุฏู - ุงูุจูุฆู (NEW CARD LOGIC)
        // *****************************************************************
        const getEconomicEnvironmentalAnalysis = () => {
            const { resources, industries, pollution } = governorateResources[selectedCity] || {};
            const aqi = airQualityData?.data?.aqi ?? 0;
            const treePercentage = treeCoverageData?.percentage ?? 0;
            
            if (!resources) {
                return { status: "ุบูุฑ ูุชููุฑ", analysis: ["ูู ูุชู ุชุญุฏูุฏ ุงูุจูุงูุงุช ุงูุงูุชุตุงุฏูุฉ ูุงูุจูุฆูุฉ ููุฐู ุงููุญุงูุธุฉ."] };
            }

            let analysis = [];
            let status = "ุชูุงุฒู ููุจูู";
            let color = "text-blue-400";
            
            // 1. ุชุญููู ุงูุตูุงุนุงุช ูุงูุชููุซ
            analysis.push({
                title: "ุงูุชุญุฏู ุงูุงูุชุตุงุฏู/ุงูุจูุฆู ุงูุฑุฆูุณู", 
                details: `ุงูุงุนุชูุงุฏ ุนูู ูุทุงุน **${industries[0]}** ูุณุจุจ ุชุญุฏูุงุช ุจูุฆูุฉ ูุซู **${pollution}**.`,
                icon: IconMap.Factory
            });

            // 2. ุชุญููู ุงูููุงุฑุฏ ููุฑุต ุงูุงุณุชุฏุงูุฉ
            analysis.push({
                title: "ูุฑุต ุงูุชุญูู ุงูุฃุฎุถุฑ", 
                details: `ุชููุฑ ููุงุฑุฏ ูุซู **${resources[0]}** ู **${resources[1]}** ููุชุญ ุงูุจุงุจ ุฃูุงู ุงูุงุณุชุซูุงุฑ ูู ุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ ุฃู ุงูุณูุงุญุฉ ุงูุจูุฆูุฉุ ูุฎูุถ ุงูุงุนุชูุงุฏ ุนูู ุงูุตูุงุนุงุช ุงููููุซุฉ.`,
                icon: IconMap.Sun
            });
            
            // 3. ุงูุฑุจุท ูุน ุฌูุฏุฉ ุงูููุงุก ูุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ
            if (aqi > 100 || treePercentage < 10) {
                analysis.push({
                    title: "ุงูุฎุณุงุฆุฑ ุงูุงูุชุตุงุฏูุฉ ุงููุญุชููุฉ", 
                    details: `ุงูุฎูุงุถ ุฌูุฏุฉ ุงูููุงุก (${aqi} AQI) ูุถุนู ุงูุบุทุงุก ุงูุดุฌุฑู (${treePercentage}%) ูููุฏุฏ ุจุฒูุงุฏุฉ ุชูุงููู ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ูุฎุณุงุฑุฉ ุงูุฌุงุฐุจูุฉ ุงูุณูุงุญูุฉ/ุงูุงุณุชุซูุงุฑูุฉ.`,
                    icon: IconMap.AlertTriangle
                });
                status = "ุชูุงุฒู ูููุฏููุฏ";
                color = "text-orange-400";
            } else {
                analysis.push({
                    title: "ูููุฉ ุงูููุงุฑุฏ ุงูุทุจูุนูุฉ (Capital)", 
                    details: `ุงูุจูุฆุฉ ุงููุธููุฉ ูุฑุฃุณ ุงููุงู ุงูุทุจูุนู (ุงูููู/ุงูุจุญุฑ) ูุฏุนูุงู ูุทุงุนุงุช **ุงูุณูุงุญุฉ** ู **ุงูุฒุฑุงุนุฉ** ููุญุฑูุงุช ููููู ุงููุณุชุฏุงู.`,
                    icon: IconMap.Economy
                });
            }

            return { status, analysis, color };
        };


        // *****************************************************************
        // 6. ููุทู ุฌูุจ ุงูุจูุงูุงุช (Data Fetching Logic)
        // *****************************************************************
        const fetchData = async () => {
            loading = true;
            chatbotResponse = null; // ุฅุนุงุฏุฉ ุชุนููู ุฑุฏ ุงูุดุงุช ุจูุช ูุจู ูู ุฌูุจ ุจูุงูุงุช
            render(); 
            const { lat, lon, treeCoverage } = governorates[selectedCity];
            const OWM_URL = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=ar`;
            const AQI_URL = `https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`;
            
            // ุญุณุงุจ ุจูุงูุงุช ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ ููุฑุงู ูุฃููุง ุจูุงูุงุช ุซุงุจุชุฉ
            treeCoverageData = { percentage: treeCoverage, ...getTreeStatus(treeCoverage) }; 

            try {
                // ุฌูุจ ุจูุงูุงุช ุงูุทูุณ ูุฌูุฏุฉ ุงูููุงุก 
                const [weatherResponse, aqiResponse] = await Promise.all([ 
                    fetch(OWM_URL).then(res => res.json()), 
                    fetch(AQI_URL).then(res => res.json())
                ]);

                weatherData = weatherResponse.cod === 200 ? weatherResponse : null;
                airQualityData = aqiResponse.status === 'ok' ? aqiResponse : null;
                
                // ุญุณุงุจ ุงูุจูุงูุงุช ุงููุดุชูุฉ ุจุนุฏ ุฌูุจ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
                disasterWarningData = getDisasterWarning(weatherData);
                const currentAqi = airQualityData?.data?.aqi ?? 0, currentTemp = weatherData?.main?.temp ?? 0, currentHumidity = weatherData?.main?.humidity ?? 0;
                const riskPercentage = calculateHealthRisk(currentAqi, currentTemp, currentHumidity);
                healthRiskData = { percentage: riskPercentage, ...getHealthRiskStatus(riskPercentage, currentAqi, currentTemp) };
                
                // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุดูู ูููุตู ุจุนุฏ ุฃู ุชุตุจุญ ุฌููุน ุงูุจูุงูุงุช ุฌุงูุฒุฉ
                chatbotResponse = await fetchChatbotResponse(); 

            } catch (error) {
                console.error("Failed to fetch data:", error);
                weatherData = null; airQualityData = null; disasterWarningData = null;
                
                // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฑุณุงูุฉ ูู ุญุงูุฉ ุงููุดู
                if (!chatbotResponse) {
                    chatbotResponse = [
                        "ุชุนุฐุฑ ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ.",
                        "* **ุฎุทุฃ:** ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ุฃู ููุงุชูุญ API."
                    ];
                }
            } finally {
                loading = false;
                render();
            }
        };

        // *****************************************************************
        // 7. ููุทู ูููุชุจุฉ ุงูุญููู
        // *****************************************************************
        const getSolutions = () => {
            const resources = governorateResources[selectedCity] || { type: 'generic', resources: [] };
            const treeData = treeCoverageData;
            const aqi = airQualityData?.data?.aqi ?? 0;

            // --- 1. ุญููู ุงููุณุงุญุงุช ุงูุฎุถุฑุงุก ---
            let greenSolutions = { title: "ุญููู ูุฒูุงุฏุฉ ุงูุฑูุนุฉ ุงูุฎุถุฑุงุก", icon: IconMap.Tree, color: "text-green-400", proposals: [] };
            if (treeData.percentage < 10) greenSolutions.proposals.push({ title: "ูุจุงุฏุฑุงุช ุฒุฑุงุนุฉ ุนุงุฌูุฉ", details: "ุชูููุฐ ุญููุงุช ุชุดุฌูุฑ ูุงุณุนุฉ ุงููุทุงู ูู ุงูุฃุญูุงุก ุงูุณูููุฉ ูุงูููุงุทู ุงูุตูุงุนูุฉ.", icon: IconMap.Alert });
            if (resources.type.includes('urban')) greenSolutions.proposals.push({ title: "ุงูุฒุฑุงุนุฉ ุงูุฑุฃุณูุฉ ูุฃุณุทุญ ุงููุจุงูู ุงูุฎุถุฑุงุก", details: "ุงุณุชุบูุงู ุงููุงุฌูุงุช ูุงูุฃุณุทุญ ูุฅูุดุงุก ุญุฏุงุฆู ุฑุฃุณูุฉุ ููุง ูุณุงูู ูู ุฎูุถ ุญุฑุงุฑุฉ ุงููุจุงูู ูุชูููุฉ ุงูููุงุก.", icon: IconMap.Tree });
            if (resources.type.includes('desert')) greenSolutions.proposals.push({ title: "ุฒุฑุงุนุฉ ูุจุงุชุงุช ูุญููุฉ ููุงููุฉ ููุฌูุงู", details: "ุงูุชุฑููุฒ ุนูู ุฒุฑุงุนุฉ ุฃุดุฌุงุฑ ูุซู ุงูููู ูุงูุฃูุงุณูุงุ ุงูุชู ุชุชููู ูุน ุงูุธุฑูู ุงูุตุญุฑุงููุฉ.", icon: IconMap.Droplet });
            else greenSolutions.proposals.push({ title: "ุงูุชุฑุงุญ ูุจุงุชุงุช ูุชูุงููุฉ ูุน ุงูุจูุฆุฉ", details: "ุฒุฑุงุนุฉ ุฃุดุฌุงุฑ ูุซูุฑุฉ ููุญููุฉ ูุซู ุงูุฌููุฒ ูุงูุชูุชุ ูุงูุชู ุชููุฑ ุธูุงู ูุบุฐุงุกู.", icon: IconMap.Tree });
            
            // --- 2. ุญููู ุชููุซ ุงูููุงุก ---
            let pollutionSolutions = { title: "ุญููู ูููุงุฌูุฉ ุชููุซ ุงูููุงุก", icon: IconMap.AirLarge, color: "text-purple-400", proposals: [] };
            if (aqi > 100) {
                pollutionSolutions.proposals.push({ title: "ุฅูุดุงุก ููุงุทู ููุฎูุถุฉ ุงูุงูุจุนุงุซุงุช (LEZ)", details: "ููุน ุฏุฎูู ุงููุฑูุจุงุช ุงููุฏููุฉ ูุงูุฃูุซุฑ ุชูููุซูุง ูููุงุทู ูุญุฏุฏุฉุ ูุน ุชุดุฌูุน ุงุณุชุฎุฏุงู ุงูุณูุงุฑุงุช ุงูููุฑุจุงุฆูุฉ.", icon: IconMap.Wind });
                pollutionSolutions.proposals.push({ title: "ูุธุงู ุฐูู ูุฅุฏุงุฑุฉ ุงููุฑูุฑ", details: "ุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุจูุงูุงุช ุงููุฑูุฑ ูุชุนุฏูู ุชูููุช ุฅุดุงุฑุงุช ุงููุฑูุฑ ูุชูููู ุงูุงูุจุนุงุซุงุช.", icon: IconMap.Satellite });
            }
            if (resources.type.includes('nile_delta')) pollutionSolutions.proposals.push({ title: "ููุงูุญุฉ ุญุฑู ูุด ุงูุฃุฑุฒ", details: "ุชูููุฑ ูุนุฏุงุช ูููุฒุงุฑุนูู ูุชุญููู ูุด ุงูุฃุฑุฒ ุฅูู ุฃุนูุงู ูุฃุณูุฏุฉ ุนุถููุฉ ุจุฏูุงู ูู ุญุฑูู.", icon: IconMap.AlertTriangle });
            if (pollutionSolutions.proposals.length === 0) pollutionSolutions.proposals.push({ title: "ุงูุญูุงุธ ุนูู ุฌูุฏุฉ ุงูููุงุก", details: "ุฌูุฏุฉ ุงูููุงุก ุงูุญุงููุฉ ุฌูุฏุฉุ ูููุตุญ ุจุงูุงุณุชูุฑุงุฑ ูู ุงููุฑุงูุจุฉ ูุชุทุจูู ุงูุณูุงุณุงุช ุงูููุงุฆูุฉ.", icon: IconMap.Wind });
            
            // --- 3. ุญููู ุงูุทุงูุฉ ูุงูููุงุตูุงุช ---
            let energySolutions = { title: "ุญููู ููุญูุงุธ ุนูู ูุตุงุฏุฑ ุงูุทุงูุฉ", icon: IconMap.Sun, color: "text-amber-400", proposals: [] };
            if (resources.resources.includes('ุณุทูุน ุดูุณู ุนุงูู')) energySolutions.proposals.push({ title: "ุชูุณุน ูู ูุญุทุงุช ุงูุทุงูุฉ ุงูุดูุณูุฉ", details: `ุงุณุชุบูุงู ุงูุณุทูุน ุงูุดูุณู ุงูุนุงูู ูู ${selectedCity} ูุฅูุดุงุก ูุญุทุงุช ุทุงูุฉ ุดูุณูุฉ ูุจุฑู.`, icon: IconMap.Sun });
            if (resources.type.includes('coastal')) energySolutions.proposals.push({ title: "ูุดุงุฑูุน ุทุงูุฉ ุงูุฑูุงุญ ุงูุจุญุฑูุฉ", details: "ุจูุงุก ูุฒุงุฑุน ุฑูุงุญ ุนูู ุทูู ุงูุณุงุญู ููุงุณุชูุงุฏุฉ ูู ุณุฑุนุงุช ุงูุฑูุงุญ ุงูููุชุธูุฉ.", icon: IconMap.WindHigh });
            energySolutions.proposals.push({ title: "ุฅุถุงุกุฉ ุงูุดูุงุฑุน ุจุงูุทุงูุฉ ุงูุดูุณูุฉ", details: "ุงุณุชุจุฏุงู ุฃุนูุฏุฉ ุงูุฅูุงุฑุฉ ุงูุญุงููุฉ ุจุฃุฎุฑู ุชุนูู ุจุงูุทุงูุฉ ุงูุดูุณูุฉ ููุตุงุจูุญ LED ุฐููุฉ.", icon: IconMap.Location });
            if (resources.type.includes('coastal') || resources.type.includes('nile')) energySolutions.proposals.push({ title: "ุงูููู ุงูููุฑู/ุงูุจุญุฑู ุงูููุฑุจุงุฆู", details: "ุชุดุบูู ุนุจูุงุฑุงุช ูููุงุฑุจ ููุฑุจุงุฆูุฉ ุตุบูุฑุฉ ููุณููุฉ ููู ุนุงูุฉ ูุชูููู ุงูุถุบุท ุนูู ุงูุทุฑู.", icon: IconMap.Wind });
            
            // --- 4. ุจุทุงูุฉ ุงูุชุญููู ุงูุงูุชุตุงุฏู - ุงูุจูุฆู (NEW CARD)
            const ecoAnalysis = getEconomicEnvironmentalAnalysis();
            const economicEnvironmentalCard = {
                title: "๐ ุงูุชุญููู ุงูุงูุชุตุงุฏู - ุงูุจูุฆู",
                details: ecoAnalysis.analysis,
                icon: IconMap.Economy,
                color: ecoAnalysis.color,
                isEcoCard: true // ุนูุงูุฉ ูุชูููุฒูุง ูู ุฏุงูุฉ ุงูุนุฑุถ
            };

            // --- 5. ุจุทุงูุฉ ุงูุงูุชุฑุงุญุงุช ุงูุฐููุฉ (ุชุณุชุฎุฏู ุฑุฏ ุงูู API ุงููุฎุฒู)
            const smartSuggestionsCard = {
                title: "๐ค ุงูุชุฑุงุญุงุช ุฐููุฉ (ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู)",
                details: chatbotResponse || [LoadingSpinner("ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูุชูููุฏ ุงูุงูุชุฑุงุญุงุช...")], 
                icon: IconMap.Satellite
            };

            return [smartSuggestionsCard, economicEnvironmentalCard, greenSolutions, pollutionSolutions, energySolutions];
        };
        
        // *****************************************************************
        // 8. ููุทู ุนุฑุถ ุงูููููุงุช (Rendering Logic)
        // *****************************************************************

        // *** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ุงููุนุจุฉ ุงูุฌุฏูุฏุฉ ุงููุฏูุฌุฉ ***
        function renderGameCard() {
            return CardTemplate(
                "๐ฎ ูุนุจุฉ ุงูุชุดุฌูุฑ",
                IconMap.Tree,
                "text-lime-500",
                `
                    <div class="text-center">
                        <p class="text-gray-300 text-sm">ูู ุฌุฒุกุงู ูู ูุจุงุฏุฑุฉ ุงูุชุดุฌูุฑ ูุฒุฑุน ุงูุฃุดุฌุงุฑ ุงูุชุฑุงุถูุงู! ๐ฑ</p>
                        <button id="plant-btn" class="bg-lime-600 hover:bg-lime-700 text-white font-bold px-5 py-2 rounded-lg mt-4 transition duration-300 shadow-md transform hover:scale-[1.02]">
                            ๐ฑ ุงุฒุฑุน ุดุฌุฑุฉ ุงูุขู
                        </button>
                        <p id="tree-count" class="mt-4 text-3xl font-extrabold text-lime-400">${treesPlanted}</p>
                        <p class="text-sm text-gray-400">ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุฒุฑูุนุฉ (ุงูุชุฑุงุถูุงู)</p>
                        <div id="forest" class="mt-3 flex flex-wrap gap-1 justify-center max-h-16 overflow-y-auto pt-2 border-t border-gray-700/50">
                            ${Array(Math.min(treesPlanted, 20)).fill('๐ณ').join('')}
                            ${treesPlanted > 20 ? `<span class="text-xl text-gray-500">+${treesPlanted - 20}</span>` : ''}
                        </div>
                    </div>
                `,
                // ุชุตุบูุฑ ุญุฌู ุงูุจุทุงูุฉ ูุชูุงุณุจ ุดุจูุฉ ุงูุญููู
                "col-span-1" 
            );
        }

        // *** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ุงูุจุตูุฉ ุงููุฑุจูููุฉ ุงููุฏูุฌุฉ ***
        function renderCarbonFootprintCard() {
            return CardTemplate(
                "๐ฑ ุงูุจุตูุฉ ุงููุฑุจูููุฉ (ุดุฎุตูุฉ)",
                IconMap.AlertTriangle,
                "text-blue-400",
                `
                    <div class="space-y-4">
                        <p class="text-gray-300 text-sm">ุฃุฏุฎู ุงุณุชููุงูู ุงูุดูุฑู ูุญุณุงุจ ุจุตูุชู ุงูุชูุฏูุฑูุฉ (ูุฌู COโ).</p>
                        <form id="carbon-form" class="space-y-3 text-sm">
                            <label class="block text-right">ุงุณุชููุงู ุงูููุฑุจุงุก (ูููููุงุช/ุดูุฑ): 
                                <input type="number" id="electricity" placeholder="ูุซุงู: 500" />
                            </label>
                            <label class="block text-right">ุงูููุงุตูุงุช (ูู/ุดูุฑ): 
                                <input type="number" id="transport" placeholder="ูุซุงู: 300" />
                            </label>
                            <label class="block text-right">ุจูุงุณุชูู (ูุฌู/ุดูุฑ): 
                                <input type="number" id="plastic" placeholder="ูุซุงู: 5" />
                            </label>
                            <button type="submit" class="text-white rounded-lg transition duration-300 shadow-lg">
                                ุงุญุณุจ ุงูุจุตูุฉ ๐
                            </button>
                        </form>
                        <p id="carbon-result" class="mt-4 text-center text-lg font-bold min-h-[1.5rem]">
                            </p>
                    </div>
                `,
                // ุชุตุบูุฑ ุญุฌู ุงูุจุทุงูุฉ ูุชูุงุณุจ ุดุจูุฉ ุงูุญููู
                "col-span-1" 
            );
        }


        const renderHeader = () => `
            <header class="bg-gray-900/90 backdrop-blur-sm sticky top-0 z-10 p-4 border-b border-gray-700 shadow-xl">
                <div class="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-4">
                    <h1 class="text-3xl font-extrabold text-blue-400 flex items-center gap-2">
                        ${IconMap.Satellite} ูุฑุตุฏ ูุตุฑ 2025
                    </h1>
                    
                    <div class="flex items-center gap-2 text-sm">
                        <label for="city-select" class="text-gray-300 font-semibold">ุงููุญุงูุธุฉ:</label>
                        <select id="city-select" class="bg-gray-700 text-white rounded-lg p-2 governorate-btn border border-gray-600 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition" 
                                onchange="handleCityChange(this.value)">
                            ${Object.keys(governorates).map(city => 
                                `<option value="${city}" ${city === selectedCity ? 'selected' : ''}>${city}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <nav class="flex space-x-2 space-x-reverse">
                        <button onclick="handleViewChange('dashboard')" class="px-5 py-2 rounded-full font-bold transition duration-300 
                                ${currentView === 'dashboard' ? 'bg-blue-600 text-white shadow-md shadow-blue-500/50' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                            ุงูุจูุงูุงุช ุงูุญูุฉ (Dashboard)
                        </button>
                        <button onclick="handleViewChange('solutions')" class="px-5 py-2 rounded-full font-bold transition duration-300 
                                ${currentView === 'solutions' ? 'bg-blue-600 text-white shadow-md shadow-blue-500/50' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                            ุงูุญููู ุงูุฐููุฉ
                        </button>
                    </nav>
                </div>
            </header>
        `;

        // *** ุฏุงูุฉ ุงูุทูุณ ุงูููุญุณูููุฉ ***
        const renderWeatherCard = () => {
            const temp = weatherData?.main?.temp ?? 'N/A';
            const description = weatherData?.weather?.[0]?.description ?? 'ุบูุฑ ูุชููุฑ';
            const iconCode = weatherData?.weather?.[0]?.icon ?? '50d';
            const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`; 
            const sunrise = formatTime(weatherData?.sys?.sunrise);
            const sunset = formatTime(weatherData?.sys?.sunset);
            const windSpeed = weatherData?.wind?.speed ?? 'N/A'; // ุณุฑุนุฉ ุงูุฑูุงุญ
            const windDirection = weatherData?.wind?.deg ? `(${weatherData.wind.deg}ยฐ)` : ''; // ุงุชุฌุงู ุงูุฑูุงุญ ุจุงูุฏุฑุฌุงุช

            return CardTemplate(
                "ุงูุทูุณ ุงูุญุงูู",
                IconMap.Thermometer,
                colors.secondaryAccent,
                `
                    <div class="flex items-start justify-between gap-4 pt-3">
                        
                        <div class="text-center flex-grow">
                            <img src="${iconUrl}" alt="${description}" class="w-24 h-24 mx-auto" style="filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));">
                            <p class="text-6xl font-extrabold mt-1 text-white">${Math.round(temp)}ยฐC</p>
                            <p class="text-md text-gray-300 font-semibold">${description}</p>
                        </div>
                        
                        <div class="text-right space-y-3 text-sm border-r-2 border-gray-700/50 pr-4 flex-shrink-0">
                            
                            <p class="text-gray-300 flex justify-end items-center gap-2">
                                <span class="font-bold text-lg">${weatherData?.main?.humidity ?? 'N/A'}%</span>
                                <span class="w-5 h-5 text-blue-400">${IconMap.Droplet}</span> ุงูุฑุทูุจุฉ
                            </p>
                            
                            <p class="text-gray-300 flex justify-end items-center gap-2">
                                <span class="font-bold text-lg">${windSpeed} ู/ุซ ${windDirection}</span>
                                <span class="w-5 h-5 text-lime-400 wind-icon">${IconMap.Wind}</span> ุงูุฑูุงุญ
                            </p>
                            
                            <hr class="border-gray-700/70">
                            
                            <p class="text-gray-300 flex justify-end items-center gap-2">
                                <span class="font-bold">${sunrise}</span>
                                <span class="w-5 h-5 text-amber-400">${IconMap.Sun}</span> ุดุฑูู
                            </p>
                            
                            <p class="text-gray-300 flex justify-end items-center gap-2">
                                <span class="font-bold">${sunset}</span>
                                <span class="w-5 h-5 text-amber-400">${IconMap.Sun}</span> ุบุฑูุจ
                            </p>
                        </div>
                    </div>
                `,
                "col-span-1 md:col-span-2 lg:col-span-2" // ุชู ุชูุณูุน ุงูุจุทุงูุฉ ูุชุชุณุน ููุจูุงูุงุช ุงูุฌุฏูุฏุฉ
            );
        };
        // *** ููุงูุฉ ุฏุงูุฉ ุงูุทูุณ ุงูููุญุณูููุฉ ***

        const renderAirQualityCard = () => {
            const aqi = airQualityData?.data?.aqi ?? null;
            const status = getAqiStatus(aqi);
            const colorClass = getAqiColor(aqi);

            return CardTemplate(
                "ุฌูุฏุฉ ุงูููุงุก (AQI)",
                IconMap.AirLarge,
                colorClass,
                `
                    <div class="text-center pt-3">
                        <p class="text-5xl font-extrabold ${colorClass} mb-4">${aqi ?? 'N/A'}</p>
                        <p class="text-xl font-semibold mb-6">${status}</p>
                        <div class="grid grid-cols-3 gap-2 text-right text-xs pt-3 border-t border-gray-700/50">
                            <div><p class="text-gray-400">PM2.5:</p><p class="text-white font-bold text-sm">${airQualityData?.data?.iaqi?.pm25?.v ?? 'N/A'}</p></div>
                            <div><p class="text-gray-400">NO2:</p><p class="text-white font-bold text-sm">${airQualityData?.data?.iaqi?.no2?.v ?? 'N/A'}</p></div>
                            <div><p class="text-gray-400">O3:</p><p class="text-white font-bold text-sm">${airQualityData?.data?.iaqi?.o3?.v ?? 'N/A'}</p></div>
                        </div>
                    </div>
                `,
                "col-span-1 lg:col-span-1" // ุชู ุชุตุบูุฑ ุญุฌููุง ููููุงู ูู AQI
            );
        };
        
        const renderTreeCoverageCard = () => {
            const treeData = treeCoverageData;
            const percentage = treeData?.percentage ?? 0;
            const status = treeData?.status ?? 'ุบูุฑ ูุชููุฑ';
            const recommendation = treeData?.recommendation ?? 'ุฌุงุฑู ุชูููู ุงููุถุน.';

            return CardTemplate(
                "ุงูุชุบุทูุฉ ุงูุดุฌุฑูุฉ",
                IconMap.Tree,
                treeData?.color ?? "text-gray-400",
                `
                    <div class="space-y-4 pt-3">
                        <div class="flex justify-between items-center">
                            <span class="text-5xl font-extrabold ${treeData?.color ?? "text-gray-400"}">${percentage}%</span>
                            <span class="text-xl font-semibold">${status}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="h-3 rounded-full ${treeData?.barColor ?? "bg-gray-500"}" style="width: ${percentage}%;"></div>
                        </div>
                        <p class="text-sm text-gray-400 mt-2 border-r-4 border-lime-400 pr-2">${recommendation}</p>
                    </div>
                `,
                "col-span-1 lg:col-span-1" // ุชู ุชุตุบูุฑ ุญุฌููุง ููููุงู ูู Tree Coverage
            );
        };

        const renderHealthRiskCard = () => {
            const risk = healthRiskData;
            const percentage = risk?.percentage ?? 0;
            const status = risk?.status ?? 'ุบูุฑ ูุชููุฑ';
            const recommendation = risk?.recommendation ?? 'ุฌุงุฑู ุชูููู ุงููุฎุงุทุฑ.';

            return CardTemplate(
                "ูุคุดุฑ ุงููุฎุงุทุฑ ุงูุตุญูุฉ",
                IconMap.Alert,
                risk?.color ?? "text-gray-400",
                `
                    <div class="space-y-4 pt-3">
                        <div class="flex justify-between items-center pb-2">
                            <span class="text-5xl font-extrabold ${risk?.color ?? "text-gray-400"}">${percentage}%</span>
                            <span class="text-xl font-semibold">${status}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="h-3 rounded-full ${risk?.barColor ?? "bg-gray-500"}" style="width: ${percentage}%;"></div>
                        </div>
                        <p class="text-sm text-gray-400 border-r-4 border-blue-400 pr-2 pt-2">${recommendation}</p>
                        
                        <div class="grid grid-cols-3 gap-4 text-sm pt-4 border-t border-gray-700/50">
                            <div class="text-center"><p class="font-bold text-gray-300">ุงูุชููุณ:</p><p class="${risk?.healthDetails?.respiratory?.color} text-base">${risk?.healthDetails?.respiratory?.level}</p></div>
                            <div class="text-center"><p class="font-bold text-gray-300">ุงูุญุฑุงุฑุฉ:</p><p class="${risk?.healthDetails?.heatStress?.color} text-base">${risk?.healthDetails?.heatStress?.level}</p></div>
                            <div class="text-center"><p class="font-bold text-gray-300">ุงูุญุณุงุณูุฉ:</p><p class="${risk?.healthDetails?.allergy?.color} text-base">${risk?.healthDetails?.allergy?.level}</p></div>
                        </div>
                    </div>
                `,
                "col-span-full md:col-span-2 lg:col-span-2"
            );
        };

        const renderDisasterWarningCard = () => {
            const warnings = disasterWarningData || [];
            if (warnings.length === 0) {
                return CardTemplate(
                    "ุชูุจููุงุช ุงูููุงุฑุซ",
                    IconMap.AlertTriangle,
                    "text-green-500",
                    `<p class="text-lg font-bold text-center text-green-400 mt-4">โ ูุง ุชูุฌุฏ ุชูุจููุงุช ุทุงุฑุฆุฉ ุญุงููุงู.</p>`,
                    "col-span-full"
                );
            }
            
            const content = warnings.map(w => `
                <div class="flex items-start gap-4 p-3 bg-gray-700/50 rounded-lg border-r-4 border-current hover:bg-gray-700 transition duration-150" style="border-color: ${w.iconColor.replace('text-', '').replace('500', '600')}">
                    <span class="flex-shrink-0 w-6 h-6 ${w.iconColor}">${IconMap.Alert}</span>
                    <div>
                        <p class="font-bold text-white text-sm">${w.type}</p>
                        <p class="text-xs text-gray-300">${w.message}</p>
                    </div>
                </div>
            `).join('');

            return CardTemplate(
                "ุชูุจููุงุช ุงูููุงุฑุซ",
                IconMap.AlertTriangle,
                "text-red-500",
                `<div class="space-y-3 pt-3">${content}</div>`,
                "col-span-full"
            );
        };
        
        const renderDashboardView = () => `
            <main class="max-w-7xl mx-auto p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-6">
                    ${renderDisasterWarningCard()}
                    
                    ${renderWeatherCard()} ${renderAirQualityCard()}
                    ${renderTreeCoverageCard()}
                    
                    ${renderHealthRiskCard()} </div>
            </main>
        `;

        const renderSolutionCard = (solution, span = "col-span-1") => {
            let contentHtml;
            if (solution.isEcoCard) {
                // ุนุฑุถ ุจุทุงูุฉ ุงูุชุญููู ุงูุงูุชุตุงุฏู-ุงูุจูุฆู
                contentHtml = solution.details.map(p => `
                    <div class="flex items-start gap-3">
                        <div class="w-6 h-6 text-yellow-400 flex-shrink-0">${p.icon}</div>
                        <div class="text-right">
                            <p class="font-bold text-sm text-white">${p.title}</p>
                            <p class="text-xs text-gray-400 border-r border-gray-600 pr-2">${p.details}</p>
                        </div>
                    </div>
                `).join('<hr class="border-gray-700 my-4">');
            } else if (solution.title.includes("ุงูุชุฑุงุญุงุช ุฐููุฉ")) {
                // ุนุฑุถ ุจุทุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                contentHtml = loading && !chatbotResponse
                    ? LoadingSpinner("ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูุชูููุฏ ุงูุงูุชุฑุงุญุงุช...")
                    : solution.details.map(line => 
                        line.startsWith('*') 
                        ? `<p class="text-gray-200 font-semibold text-sm flex items-start gap-1"><span class="text-blue-400 text-lg ml-2">โข</span>${line.substring(1).trim()}</p>`
                        : `<p class="text-white font-normal text-base">${line}</p>`
                    ).join('<div class="h-2"></div>');
            } else {
                // ุนุฑุถ ุจุทุงูุงุช ุงูุญููู ุงููููุฌูุฉ (ุงูููุงุกุ ุงูุทุงูุฉุ ุงูุฎุถุฑุงุก)
                contentHtml = solution.proposals.map(p => `
                    <div class="flex items-start gap-3">
                        <div class="w-5 h-5 text-lime-400 flex-shrink-0">${p.icon}</div>
                        <div class="text-right">
                            <p class="font-bold text-sm text-white">${p.title}</p>
                            <p class="text-xs text-gray-400">${p.details}</p>
                        </div>
                    </div>
                `).join('<hr class="border-gray-700 my-4">');
            }


            return `
                <div class="solution-card rounded-2xl p-6 shadow-2xl space-y-4 transition duration-300 hover:shadow-blue-500/20 ${span}">
                    <div class="flex items-center gap-3 border-b border-gray-700/50 pb-3">
                        <div class="w-7 h-7 ${solution.color}">${solution.icon}</div>
                        <h3 class="text-xl font-bold text-white">${solution.title}</h3>
                    </div>
                    <div class="space-y-4 pr-3 border-r-2 border-blue-400/50">
                        ${contentHtml}
                    </div>
                </div>
            `;
        };

        const renderSolutionsView = () => {
            const solutions = getSolutions();
            const smartCard = solutions[0];
            const economicCard = solutions[1];
            const otherSolutions = solutions.slice(2);

            return `
                <main class="max-w-7xl mx-auto p-6">
                    <h2 class="text-4xl font-extrabold text-white mb-6">ุงูุญููู ุงูุงุณุชุฑุงุชูุฌูุฉ ูุงูุฃุฏูุงุช ุงูุชูุงุนููุฉ ูู: <span class="text-blue-400">${selectedCity}</span></h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        ${renderSolutionCard(smartCard, "col-span-1")}
                        ${renderSolutionCard(economicCard, "col-span-1")}
                    </div>
                    
                    <h3 class="text-3xl font-bold text-gray-300 mb-6 border-b border-gray-700/70 pb-3">2. ุงูุญููู ุงููููุฌูุฉ ุงูููุตู ุจูุง</h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        ${otherSolutions.map(s => renderSolutionCard(s, "col-span-1")).join('')}
                    </div>
                    
                    <h3 class="text-3xl font-bold text-gray-300 mb-6 border-b border-gray-700/70 pb-3">3. ุงูุฃุฏูุงุช ุงูุชูุงุนููุฉ ูุงููุดุงุฑูุฉ ุงููุฌุชูุนูุฉ</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${renderGameCard()} 
                        ${renderCarbonFootprintCard()}
                    </div>
                </main>
            `;
        };
        
        const render = () => {
            const appContainer = document.getElementById('app-container');
            let content = renderHeader();
            
            if (currentView === 'dashboard') {
                content += renderDashboardView();
            } else {
                content += renderSolutionsView();
            }

            appContainer.innerHTML = content;
        };
        
        // *****************************************************************
        // 9. ูุนุงูุฌุงุช ุงูุฃุญุฏุงุซ (Event Handlers)
        // *****************************************************************
        const handleCityChange = (newCity) => {
            if (newCity !== selectedCity) {
                selectedCity = newCity;
                currentView = 'dashboard';
                fetchData();
            }
        };
        const handleViewChange = (view) => {
            currentView = view;
            render();
        };

        // *** ูุนุงูุฌ ุญุฏุซ ุงูููุฑ ุนูู ุฒุฑ ุงูุฒุฑุงุนุฉ ***
        document.addEventListener("click", (e) => {
            if (e.target.id === "plant-btn") {
                treesPlanted++;
                
                // ุชุญุฏูุซ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ูุงููุต ูู ุงูุจุทุงูุฉ ูุจุงุดุฑุฉ ุฏูู ุฅุนุงุฏุฉ ุชุญููู ูู ุงูู render
                const treeCountElement = document.getElementById("tree-count");
                const forestElement = document.getElementById("forest");

                if (treeCountElement) {
                    treeCountElement.textContent = treesPlanted;
                }
                
                if (forestElement) {
                    const tree = document.createElement("span");
                    tree.textContent = "๐ณ";
                    tree.className = "text-xl transition duration-500 transform hover:scale-125";
                    
                    // ุฅุถุงูุฉ ุงูุดุฌุฑุฉ ูู ุงูุจุฏุงูุฉ ูุณูููุฉ ุงูุฑุคูุฉ
                    forestElement.prepend(tree); 
                    
                    // ุฅุจูุงุก ุนุฏุฏ ูุญุฏูุฏ ูู ุงูุฃููููุงุช ููุณุฑุนุฉ ูุงูุฃุฏุงุก (20 ุฃููููุฉ ูุงููุฉ)
                    while (forestElement.children.length > 20) {
                        forestElement.removeChild(forestElement.lastChild);
                    }
                }
            }
        });
        
        // *** ูุนุงูุฌ ุญุฏุซ ุฅุฑุณุงู ูููุฐุฌ ุงูุจุตูุฉ ุงููุฑุจูููุฉ ุงููุฏูุฌ ***
        document.addEventListener("submit", (e) => {
            if (e.target.id === "carbon-form") {
                e.preventDefault();
                
                // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุญููู ููุฌูุฏุฉ
                const electricityInput = document.getElementById("electricity");
                const transportInput = document.getElementById("transport");
                const plasticInput = document.getElementById("plastic");
                const resultElement = document.getElementById("carbon-result");

                if (!electricityInput || !transportInput || !plasticInput || !resultElement) return;

                // ุชุญููู ุงูููู ุฅูู ุฃุฑูุงู (ุฃู ุตูุฑ ุฅุฐุง ูุงูุช ูุงุฑุบุฉ)
                const electricity = +electricityInput.value || 0;
                const transport = +transportInput.value || 0;
                const plastic = +plasticInput.value || 0;

                // ูุนุงูู ุงูุจุนุงุซุงุช ุงูุชุฑุงุถูุฉ (ูุฌู COโ ููู ูุญุฏุฉ)
                // ุงูููุฑุจุงุก (0.5): ูุชูุณุท ุงูุจุนุงุซุงุช ูุญุทุฉ ุชุนูู ุจุงูุบุงุฒ/ุงููุงุฒูุช
                // ุงูููุงุตูุงุช (0.2): ูุชูุณุท ุงูุจุนุงุซุงุช ุงูุณูุงุฑุฉ ููู ูู
                // ุงูุจูุงุณุชูู (2): ูุชูุณุท ุงูุจุนุงุซุงุช ุงูุจูุงุณุชูู ููู ูุฌู
                const footprint = electricity * 0.5 + transport * 0.2 + plastic * 2;
                
                let resultMessage;
                let resultColorClass;
                
                if (footprint > 500) {
                    resultMessage = `ุจุตูุชู ุงูุชูุฏูุฑูุฉ: ${footprint.toFixed(1)} ูุฌู COโ/ุดูุฑ ๐ด (ูุฑุชูุนุฉ ุฌุฏุงู!)`;
                    resultColorClass = "text-red-500";
                } else if (footprint > 200) {
                    resultMessage = `ุจุตูุชู ุงูุชูุฏูุฑูุฉ: ${footprint.toFixed(1)} ูุฌู COโ/ุดูุฑ ๐ก (ูุชูุณุทุฉ)`;
                    resultColorClass = "text-amber-400";
                } else {
                    resultMessage = `ุจุตูุชู ุงูุชูุฏูุฑูุฉ: ${footprint.toFixed(1)} ูุฌู COโ/ุดูุฑ ๐ข (ููุฎูุถุฉ)`;
                    resultColorClass = "text-green-400";
                }

                resultElement.textContent = resultMessage;
                resultElement.className = `mt-4 text-center text-lg font-bold ${resultColorClass}`;
            }
        });

        
        // *****************************************************************
        // 10. ุงูุฅุทูุงู ุงูุฃููู (Initialisation)
        // *****************************************************************
        fetchData();
    </script>
</body>
</html>